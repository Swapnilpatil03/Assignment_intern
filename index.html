<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Candlestick Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Use Chart.js for chart visualization -->
    <style>
        /* Global styles */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 {
            color: #333;
            font-size: 20px;
            margin-top: 20px;
        }

        /* Dropdown container styling */
        .dropdown-container {
            margin: 20px 0;
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        /* Style for dropdowns */
        select {
            padding: 10px 20px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: white;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
        }

        select:focus {
            border-color: #007bff;
        }

        /* Chart container styling */
        #chartContainer {
            width: 90%;
            height: 600px;
            margin-top: 20px;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        /* Responsive design for smaller devices */
        @media screen and (max-width: 768px) {
            #chartContainer {
                width: 100%;
                height: 500px;
            }

            .dropdown-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Coin selection and time frame dropdowns -->
    <div class="dropdown-container">
        <div>
            <h2>Select a Coin Pair</h2>
            <select id="coinPairDropdown" onchange="changeCoinPair()">
                <option value="bnbusdt">BNB/USDT</option>
                <option value="ethusdt">ETH/USDT</option>
                <option value="dotusdt">DOT/USDT</option>
            </select>
        </div>

        <div>
            <h2>Select Time Frame</h2>
            <select id="timeFrameDropdown" onchange="changeTimeFrame()">
                <option value="1m">1 Minute</option>
                <option value="3m">3 Minutes</option>
                <option value="5m">5 Minutes</option>
            </select>
        </div>
    </div>

    <!-- Chart container -->
    <div id="chartContainer"></div>

    <script src="https://s3.tradingview.com/tv.js"></script> <!-- Load TradingView library -->

    <script>
        const chartContainer = document.getElementById('chartContainer');
        let tvWidget;
        let selectedCoin = 'bnbusdt'; // Default coin
        let selectedTimeFrame = '1m'; // Default time frame
        const chartData = {}; // Object to store candle data for each coin and time frame

        // Initialize the TradingView widget
        function initTradingView(symbol, timeFrame) {
            tvWidget = new TradingView.widget({
                "width": chartContainer.clientWidth,
                "height": 600,
                "symbol": `BINANCE:${symbol.toUpperCase()}`,
                "interval": timeFrame.replace('m', ''), // Convert '1m' to '1', '5m' to '5', etc.
                "timezone": "Etc/UTC",
                "theme": "light",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "allow_symbol_change": true,
                "container_id": "chartContainer",
                "studies": [],
                "hide_top_toolbar": false,
                "hide_legend": true,
                "save_image": false,
                "hide_side_toolbar": false,
                "details": true,
                "calendar": true,
                "responsive": true,
                "widget_type": "chart",
                "watchlist": [
                    "BINANCE:BNBUSDT",
                    "BINANCE:ETHUSDT",
                    "BINANCE:DOTUSDT"
                ]
            });
        }

        // Initialize the widget for the first time
        TradingView.onready(() => {
            initTradingView(selectedCoin, selectedTimeFrame);
            connectToWebSocket(selectedCoin, selectedTimeFrame);
        });

        // Connect to the Binance WebSocket
        function connectToWebSocket(symbol, timeFrame) {
            const ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol}@kline_${timeFrame}`);

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                const candleData = data.k;

                const newCandle = {
                    time: Math.floor(candleData.t / 1000), // Convert to seconds
                    open: parseFloat(candleData.o),
                    high: parseFloat(candleData.h),
                    low: parseFloat(candleData.l),
                    close: parseFloat(candleData.c)
                };

                // Store data in localStorage for the selected coin and time frame
                const coinFrameKey = `${selectedCoin}_${selectedTimeFrame}`;
                if (!chartData[coinFrameKey]) {
                    chartData[coinFrameKey] = [];
                }
                chartData[coinFrameKey].push(newCandle);

                // Save updated data in localStorage
                localStorage.setItem('chartData', JSON.stringify(chartData));

                // Update the chart with the new data
                updateChart(chartData[coinFrameKey]);
            };
        }

        // Update the chart with the stored or new data
        function updateChart(data) {
            if (tvWidget) {
                tvWidget.onChartReady(function() {
                    tvWidget.chart().setSymbol(`BINANCE:${selectedCoin.toUpperCase()}`);
                    tvWidget.chart().updateData(data);
                });
            }
        }

        // Change the selected coin pair
        function changeCoinPair() {
            selectedCoin = document.getElementById('coinPairDropdown').value;
            reloadChart();
        }

        // Change the selected time frame
        function changeTimeFrame() {
            selectedTimeFrame = document.getElementById('timeFrameDropdown').value;
            reloadChart();
        }

        // Reinitialize the TradingView widget with the selected coin and time frame
        function reloadChart() {
            const coinFrameKey = `${selectedCoin}_${selectedTimeFrame}`;
            const storedData = JSON.parse(localStorage.getItem('chartData')) || {};
            chartData[coinFrameKey] = storedData[coinFrameKey] || [];

            // Remove the existing widget and create a new one with the selected options
            if (tvWidget) {
                tvWidget.remove();
            }
            initTradingView(selectedCoin, selectedTimeFrame);

            // Update the chart with stored data or wait for new candles
            updateChart(chartData[coinFrameKey]);
            connectToWebSocket(selectedCoin, selectedTimeFrame);
        }
    </script>
</body>
</html>
